{% extends 'base.html' %}
{% load static %}

{% block title %} Forgot Password {% endblock %}

{% block content %}
<section class="py-8 bg-base-200 min-h-screen">
  <div class="container mx-auto px-4">
    <!-- Page Header -->
    <div class="text-center mb-8">
      <div class="sideline_text text-primary mb-2">Account Recovery</div>
      <h1 class="text-4xl font-bold text-primary mb-4">Forgot Password</h1>
      <p class="text-base-content/70 max-w-md mx-auto">
        Don't worry! Enter your email address and we'll send you a link to reset your password.
      </p>
    </div>

    <div class="flex justify-center">
      <div class="card bg-base-100 shadow-2xl max-w-md w-full">
        <div class="card-body p-8">
          <!-- Alert Messages -->
          {% if messages %}
          {% for message in messages %}
          <div class="alert {{ message.tags|default:'alert-info' }} shadow-lg mb-6" role="alert">
            {% if message.tags == 'error' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% elif message.tags == 'success' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% else %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% endif %}
            <span>{{ message }}</span>
          </div>
          {% endfor %}
          {% endif %}

          <!-- School Logo & Title -->
          <div class="text-center space-y-6 mb-8">
            <div class="avatar">
              <div class="w-20 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                <img src="{% static 'images/St Marks Logo.png' %}" alt="School Logo" />
              </div>
            </div>
            
            <div class="space-y-2">
              <h2 class="text-2xl font-bold text-primary">Reset Your Password</h2>
              <p class="text-base-content/70 text-sm">
                We'll email you a secure link to reset your password
              </p>
            </div>
          </div>

          <!-- Password Reset Form -->
          <form
            id="forgot-password-form"
            method="POST"
            action="{% url 'Accounts:forgot_password' %}"
            class="space-y-6"
            hx-post="{% url 'Accounts:forgot_password' %}"
            hx-target="#form-container"
            hx-swap="outerHTML"
          >
            <div id="form-container">
              {% csrf_token %}
              
              <div class="form-control">
                <label class="label" for="email">
                  <span class="label-text font-semibold">
                    Email Address <span class="text-error">*</span>
                  </span>
                </label>
                <div class="relative">
                  <input
                    type="email"
                    name="email"
                    id="email"
                    placeholder="Enter your registered email address"
                    class="input input-bordered w-full pl-10"
                    required
                    autocomplete="email"
                  />
                  <svg class="absolute left-3 top-3 h-5 w-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </div>
                <label class="label">
                  <span class="label-text-alt text-base-content/60">
                    We'll never share your email with anyone else
                  </span>
                </label>
              </div>

              <!-- Submit Button -->
              <button
                id="submit-btn"
                type="submit"
                class="btn btn-primary w-full text-lg py-3"
              >
                <span class="loading loading-spinner loading-sm hidden" id="reset-spinner"></span>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                Send Reset Link
              </button>
            </div>
          </form>

          <!-- Additional Options -->
          <div class="divider text-sm">Need help?</div>
          
          <div class="space-y-4">
            <div class="text-center">
              <p class="text-sm text-base-content/70 mb-4">
                Remember your password?
              </p>
              <a href="{% url 'Accounts:login' %}" class="btn btn-outline btn-primary w-full">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
                Back to Sign In
              </a>
            </div>
            
            <div class="text-center">
              <p class="text-sm text-base-content/70 mb-4">
                Don't have an account yet?
              </p>
              <a href="{% url 'Accounts:signup' %}" class="btn btn-ghost btn-primary w-full">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
                Create New Account
              </a>
            </div>
          </div>

          <!-- Contact Support -->
          <div class="bg-base-200 rounded-lg p-4 mt-6">
            <div class="text-center">
              <h3 class="font-semibold text-sm mb-2">Still need help?</h3>
              <p class="text-xs text-base-content/70 mb-3">
                Contact our support team for assistance
              </p>
              <div class="flex flex-col sm:flex-row gap-2">
                <a href="mailto:support@smss.edu" class="btn btn-sm btn-outline flex-1">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  Email
                </a>
                <a href="tel:+1234567890" class="btn btn-sm btn-outline flex-1">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  Call
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('forgot-password-form');
  const submitBtn = document.getElementById('submit-btn');
  const emailInput = document.getElementById('email');
  
  // Email validation
  emailInput.addEventListener('input', function() {
    const email = this.value.trim();
    if (email && !isValidEmail(email)) {
      this.setCustomValidity('Please enter a valid email address');
      this.classList.add('input-error');
    } else {
      this.setCustomValidity('');
      this.classList.remove('input-error');
    }
  });
  
  // Form submission with loading state
  form.addEventListener('submit', function(e) {
    const email = emailInput.value.trim();
    
    if (!email || !isValidEmail(email)) {
      e.preventDefault();
      emailInput.focus();
      return;
    }
    
    // Show loading state
    const spinner = document.getElementById('reset-spinner');
    spinner.classList.remove('hidden');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <span class="loading loading-spinner loading-sm"></span>
      Sending Reset Link...
    `;
  });
  
  // Auto-focus email field
  emailInput.focus();
});

function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

// HTMX event handlers
document.addEventListener('htmx:afterRequest', function(event) {
  if (event.detail.successful) {
    // Success handling is done via Django messages
    console.log('Password reset request sent successfully');
  } else {
    // Error handling
    const submitBtn = document.getElementById('submit-btn');
    const spinner = document.getElementById('reset-spinner');
    
    if (spinner) spinner.classList.add('hidden');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
        Send Reset Link
      `;
    }
  }
});
</script>

{% endblock %}
