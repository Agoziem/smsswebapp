{% extends 'base.html' %}
{% load static %}
{% block content%}
{% include 'main_navbar.html' %}

<!-- Main page starts here -->
<section class="py-16 bg-base-100">
  <div class="container mx-auto px-4">
    <h1 class="text-4xl font-bold text-center text-primary mb-8">CBT SUBJECTS ALLOCATION</h1>
    
    <div class="grid lg:grid-cols-2 gap-8 items-start">
      <!-- Allocation Form -->
      <div class="card bg-base-200 shadow-lg">
        <div class="card-body">
          <form class="subjectallocationform space-y-6">
            <div class="form-control">
              <label class="label" for="testselect">
                <span class="label-text font-semibold">Select the Test:</span>
              </label>
              <select id="testselect" name="Test" class="select select-bordered w-full" required>
                <option value="" disabled selected>Select a Test</option>
                {% for test in tests %}
                <option value="{{ test.name }}">{{ test.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-control">
              <label class="label" for="allocationname">
                <span class="label-text font-semibold">Enter a name:</span>
              </label>
              <input type="text" name="Name" id="allocationname" 
                     class="input input-bordered w-full" 
                     placeholder="Allocation name" required>
            </div>

            <div class="form-control">
              <label class="label" for="dateselect">
                <span class="label-text font-semibold">Select the Test day:</span>
              </label>
              <input id="dateselect" type="date" name="Day" 
                     class="input input-bordered w-full" required>
            </div>

            <div class="form-control">
              <label class="label" for="subjectselect">
                <span class="label-text font-semibold">Select the Subjects:</span>
              </label>
              <select id="subjectselect" name="questions" 
                      class="select select-bordered w-full h-32" 
                      multiple required>
                {% for question in questions %}
                <option value="{{ question.id }}" class="py-2">
                  {{ question.subject }} [{% for questionclass in question.ExamClass.all %} {{questionclass.Class}} {% endfor %}]
                </option>
                {% endfor %}
              </select>
              <div class="label">
                <span class="label-text-alt">Hold Ctrl/Cmd to select multiple subjects</span>
              </div>
            </div>

            <div class="form-control">
              <button type="submit" class="btn btn-primary w-full">
                Submit allocations
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Test Allocated List -->
      <div class="card bg-base-200 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-primary mb-4">Test allocated</h2>
          {% if testgroup %}
          <ul class="space-y-2">
            {% for testallocated in testgroup %}
            <li class="p-3 bg-base-100 rounded-lg shadow-sm border-l-4 border-primary">
              {{ testallocated.name }}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-center py-8 text-base-content/60">
            <i class="fa-regular fa-folder-open text-4xl mb-4 block"></i>
            <p>No tests allocated yet</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Success Modal -->
<dialog id="submitallocationModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-success">
      <i class="fa-solid fa-check-circle mr-2"></i>
      Confirmation
    </h3>
    <p class="py-4">Test allocation submitted successfully</p>
    <div class="modal-action">
      <button class="btn btn-primary" onclick="document.getElementById('submitallocationModal').close()">
        Close
      </button>
    </div>
  </div>
</dialog>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
const subjectallocationform = document.querySelector(".subjectallocationform");
const subjectSelect = document.getElementById('subjectselect');
const testselect = document.getElementById('testselect');
const dateselect = document.getElementById('dateselect');
const allocationname = document.getElementById('allocationname');
const submitmodal = document.getElementById('submitallocationModal');

subjectallocationform.addEventListener('submit', processform);

function processform(e) {
    e.preventDefault();

    // Initialize an array to store selected questions
    const selectedQuestions = [];

    // Iterate through selected options and add values to the array
    for (const option of subjectSelect.selectedOptions) {
        selectedQuestions.push(option.value);
    }

    const formDataObject = {
        Testname: allocationname.value,
        date: dateselect.value,
        testselected: testselect.value,
        questions: selectedQuestions
    };

    submitgrouptoserver(formDataObject)
    subjectallocationform.reset()
}

function submitgrouptoserver(formDataObject){
  fetch('/testallocation/',{
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(formDataObject)
  }).then(response => response.json())
    .then(data => {
       submitmodal.showModal();
       
       setTimeout(() => {
        submitmodal.close();
       }, 3000);
    })
    .catch(error => console.error('Error:', error));
}
</script>

{% include 'main_footer.html' %}
{% endblock %}