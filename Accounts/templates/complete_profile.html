{% extends 'base.html' %}
{% load static %}

{% block title %} Complete Your Profile {% endblock %}

{% block content %}
<section class="py-8 bg-base-200 min-h-screen">
  <div class="container mx-auto px-4">
    <!-- Page Header -->
    <div class="text-center mb-8">
      <div class="sideline_text text-primary mb-2">Welcome Aboard</div>
      <h1 class="text-4xl font-bold text-primary mb-4">Complete Your Profile</h1>
      <p class="text-base-content/70 max-w-2xl mx-auto">
        Help us personalize your experience by completing your profile. This information will help us provide you with relevant content and features.
      </p>
    </div>

    <!-- Progress Indicator -->
    <div class="max-w-4xl mx-auto mb-8">
      <div class="flex items-center justify-center space-x-4">
        <div class="flex items-center">
          <div class="w-8 h-8 bg-success rounded-full flex items-center justify-center text-white font-bold text-sm">
            âœ“
          </div>
          <span class="ml-2 text-sm font-medium text-success">Account Created</span>
        </div>
        <div class="w-16 h-1 bg-success"></div>
        <div class="flex items-center">
          <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold text-sm">
            2
          </div>
          <span class="ml-2 text-sm font-medium text-primary">Complete Profile</span>
        </div>
        <div class="w-16 h-1 bg-base-300"></div>
        <div class="flex items-center">
          <div class="w-8 h-8 bg-base-300 rounded-full flex items-center justify-center text-base-content/50 font-bold text-sm">
            3
          </div>
          <span class="ml-2 text-sm font-medium text-base-content/50">Get Started</span>
        </div>
      </div>
    </div>

    <div class="flex justify-center">
      <div class="card bg-base-100 shadow-2xl max-w-4xl w-full">
        <div class="card-body p-8">
          <!-- Alert Messages -->
          {% if messages %}
          {% for message in messages %}
          <div class="alert {{ message.tags|default:'alert-info' }} shadow-lg mb-6" role="alert">
            {% if message.tags == 'error' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% elif message.tags == 'success' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% else %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% endif %}
            <span>{{ message }}</span>
          </div>
          {% endfor %}
          {% endif %}

          <!-- Welcome Section -->
          <div class="text-center space-y-6 mb-8">
            <div class="avatar">
              <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-4">
                <img src="{% static 'images/St Marks Logo.png' %}" alt="School Logo" />
              </div>
            </div>
            
            <div class="space-y-2">
              <h2 class="text-3xl font-bold text-primary">Welcome, {{ user.username }}!</h2>
              <p class="text-base-content/70">
                Let's set up your profile to get you started with the platform
              </p>
            </div>
          </div>

          <!-- Profile Completion Form -->
          <form
            id="profile-completion-form"
            method="POST"
            action="{% url 'Accounts:complete_profile' %}"
            enctype="multipart/form-data"
            class="space-y-8"
          >
            {% csrf_token %}
            
            <!-- Personal Information Section -->
            <div class="space-y-6">
              <div class="border-b border-primary/20 pb-4">
                <h3 class="text-xl font-bold text-primary mb-2">Personal Information</h3>
                <p class="text-base-content/70 text-sm">
                  Tell us about yourself to personalize your experience
                </p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Profile Picture -->
                <div class="md:col-span-2">
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Profile Picture</span>
                    </label>
                    <div class="flex items-center space-x-6">
                      <div class="avatar">
                        <div class="w-24 h-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                          <img id="profile-preview" src="{% static 'images/default-avatar.png' %}" alt="Profile Preview" />
                        </div>
                      </div>
                      <div class="space-y-2">
                        <input
                          type="file"
                          name="profile_picture"
                          id="profile_picture"
                          accept="image/*"
                          class="file-input file-input-bordered file-input-primary w-full max-w-xs"
                        />
                        <p class="text-xs text-base-content/60">
                          Upload a professional photo (JPG, PNG, max 5MB)
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- First Name -->
                <div class="form-control">
                  <label class="label" for="first_name">
                    <span class="label-text font-semibold">
                      First Name <span class="text-error">*</span>
                    </span>
                  </label>
                  <input
                    type="text"
                    name="first_name"
                    id="first_name"
                    placeholder="Enter your first name"
                    class="input input-bordered w-full"
                    required
                    value="{{ user.first_name }}"
                  />
                </div>

                <!-- Last Name -->
                <div class="form-control">
                  <label class="label" for="last_name">
                    <span class="label-text font-semibold">
                      Last Name <span class="text-error">*</span>
                    </span>
                  </label>
                  <input
                    type="text"
                    name="last_name"
                    id="last_name"
                    placeholder="Enter your last name"
                    class="input input-bordered w-full"
                    required
                    value="{{ user.last_name }}"
                  />
                </div>

                <!-- Phone Number -->
                <div class="form-control">
                  <label class="label" for="phone_number">
                    <span class="label-text font-semibold">Phone Number</span>
                  </label>
                  <input
                    type="tel"
                    name="phone_number"
                    id="phone_number"
                    placeholder="+1 (555) 000-0000"
                    class="input input-bordered w-full"
                  />
                </div>

                <!-- Date of Birth -->
                <div class="form-control">
                  <label class="label" for="date_of_birth">
                    <span class="label-text font-semibold">Date of Birth</span>
                  </label>
                  <input
                    type="date"
                    name="date_of_birth"
                    id="date_of_birth"
                    class="input input-bordered w-full"
                  />
                </div>

                <!-- Gender -->
                <div class="form-control">
                  <label class="label" for="gender">
                    <span class="label-text font-semibold">Gender</span>
                  </label>
                  <select
                    name="gender"
                    id="gender"
                    class="select select-bordered w-full"
                  >
                    <option value="" disabled selected>Select your gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                  </select>
                </div>

                <!-- Address -->
                <div class="form-control">
                  <label class="label" for="address">
                    <span class="label-text font-semibold">Address</span>
                  </label>
                  <textarea
                    name="address"
                    id="address"
                    placeholder="Enter your full address"
                    class="textarea textarea-bordered w-full"
                    rows="3"
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Professional Information Section -->
            <div class="space-y-6">
              <div class="border-b border-primary/20 pb-4">
                <h3 class="text-xl font-bold text-primary mb-2">Professional Information</h3>
                <p class="text-base-content/70 text-sm">
                  Information about your role and experience
                </p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Role/Position -->
                <div class="form-control">
                  <label class="label" for="position">
                    <span class="label-text font-semibold">
                      Position/Role <span class="text-error">*</span>
                    </span>
                  </label>
                  <input
                    type="text"
                    name="position"
                    id="position"
                    placeholder="e.g., Mathematics Teacher, Principal"
                    class="input input-bordered w-full"
                    required
                  />
                </div>

                <!-- Department -->
                <div class="form-control">
                  <label class="label" for="department">
                    <span class="label-text font-semibold">Department</span>
                  </label>
                  <select
                    name="department"
                    id="department"
                    class="select select-bordered w-full"
                  >
                    <option value="" disabled selected>Select department</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="English">English Language</option>
                    <option value="Science">Science</option>
                    <option value="Social Studies">Social Studies</option>
                    <option value="Arts">Arts</option>
                    <option value="Physical Education">Physical Education</option>
                    <option value="Administration">Administration</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <!-- Years of Experience -->
                <div class="form-control">
                  <label class="label" for="experience_years">
                    <span class="label-text font-semibold">Years of Experience</span>
                  </label>
                  <select
                    name="experience_years"
                    id="experience_years"
                    class="select select-bordered w-full"
                  >
                    <option value="" disabled selected>Select experience</option>
                    <option value="0-1">0-1 years</option>
                    <option value="2-5">2-5 years</option>
                    <option value="6-10">6-10 years</option>
                    <option value="11-15">11-15 years</option>
                    <option value="16-20">16-20 years</option>
                    <option value="20+">20+ years</option>
                  </select>
                </div>

                <!-- Qualifications -->
                <div class="form-control">
                  <label class="label" for="qualifications">
                    <span class="label-text font-semibold">Qualifications</span>
                  </label>
                  <input
                    type="text"
                    name="qualifications"
                    id="qualifications"
                    placeholder="e.g., B.Ed, M.A., Ph.D."
                    class="input input-bordered w-full"
                  />
                </div>

                <!-- Bio -->
                <div class="form-control md:col-span-2">
                  <label class="label" for="bio">
                    <span class="label-text font-semibold">Bio/About Me</span>
                  </label>
                  <textarea
                    name="bio"
                    id="bio"
                    placeholder="Tell us about yourself, your teaching philosophy, interests, etc."
                    class="textarea textarea-bordered w-full"
                    rows="4"
                  ></textarea>
                  <label class="label">
                    <span class="label-text-alt text-base-content/60">
                      This will be visible to students and colleagues
                    </span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Preferences Section -->
            <div class="space-y-6">
              <div class="border-b border-primary/20 pb-4">
                <h3 class="text-xl font-bold text-primary mb-2">Preferences</h3>
                <p class="text-base-content/70 text-sm">
                  Customize your platform experience
                </p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Language Preference -->
                <div class="form-control">
                  <label class="label" for="language_preference">
                    <span class="label-text font-semibold">Language Preference</span>
                  </label>
                  <select
                    name="language_preference"
                    id="language_preference"
                    class="select select-bordered w-full"
                  >
                    <option value="en" selected>English</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <!-- Timezone -->
                <div class="form-control">
                  <label class="label" for="timezone">
                    <span class="label-text font-semibold">Timezone</span>
                  </label>
                  <select
                    name="timezone"
                    id="timezone"
                    class="select select-bordered w-full"
                  >
                    <option value="" disabled selected>Select timezone</option>
                    <option value="UTC">UTC (GMT+0)</option>
                    <option value="EST">Eastern Time (GMT-5)</option>
                    <option value="CST">Central Time (GMT-6)</option>
                    <option value="MST">Mountain Time (GMT-7)</option>
                    <option value="PST">Pacific Time (GMT-8)</option>
                    <option value="WAT">West Africa Time (GMT+1)</option>
                  </select>
                </div>
              </div>

              <!-- Notification Preferences -->
              <div class="space-y-4">
                <h4 class="font-semibold">Notification Preferences</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <label class="label cursor-pointer justify-start">
                    <input type="checkbox" name="email_notifications" class="checkbox checkbox-primary mr-3" checked />
                    <span class="label-text">Email notifications</span>
                  </label>
                  <label class="label cursor-pointer justify-start">
                    <input type="checkbox" name="sms_notifications" class="checkbox checkbox-primary mr-3" />
                    <span class="label-text">SMS notifications</span>
                  </label>
                  <label class="label cursor-pointer justify-start">
                    <input type="checkbox" name="push_notifications" class="checkbox checkbox-primary mr-3" checked />
                    <span class="label-text">Push notifications</span>
                  </label>
                  <label class="label cursor-pointer justify-start">
                    <input type="checkbox" name="newsletter" class="checkbox checkbox-primary mr-3" checked />
                    <span class="label-text">Newsletter updates</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Terms and Privacy -->
            <div class="space-y-4">
              <div class="form-control">
                <label class="label cursor-pointer justify-start">
                  <input type="checkbox" name="privacy_agreement" class="checkbox checkbox-primary mr-3" required />
                  <span class="label-text">
                    I agree to the 
                    <a href="#" class="link link-primary">Privacy Policy</a> 
                    and understand how my data will be used
                  </span>
                </label>
              </div>
              
              <div class="form-control">
                <label class="label cursor-pointer justify-start">
                  <input type="checkbox" name="marketing_emails" class="checkbox checkbox-primary mr-3" />
                  <span class="label-text">
                    I would like to receive marketing emails about new features and updates
                  </span>
                </label>
              </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
              <button
                type="button"
                id="skip-btn"
                class="btn btn-outline btn-primary flex-1 order-2 sm:order-1"
                onclick="window.location.href='{% url "Teachers_portal:Teachers_dashboard" %}'"
              >
                Skip for Now
              </button>
              
              <button
                id="submit-btn"
                type="submit"
                class="btn btn-primary flex-1 order-1 sm:order-2 text-lg py-3"
              >
                <span class="loading loading-spinner loading-sm hidden" id="profile-spinner"></span>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Complete Profile
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('profile-completion-form');
  const submitBtn = document.getElementById('submit-btn');
  const profilePictureInput = document.getElementById('profile_picture');
  const profilePreview = document.getElementById('profile-preview');
  
  // Profile picture preview
  profilePictureInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        this.value = '';
        return;
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select a valid image file');
        this.value = '';
        return;
      }
      
      // Create preview
      const reader = new FileReader();
      reader.onload = function(e) {
        profilePreview.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
  
  // Form validation
  function validateForm() {
    const requiredFields = form.querySelectorAll('input[required], select[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        isValid = false;
      }
    });
    
    const privacyAgreement = document.querySelector('input[name="privacy_agreement"]');
    if (!privacyAgreement.checked) {
      isValid = false;
    }
    
    submitBtn.disabled = !isValid;
    return isValid;
  }
  
  // Add event listeners for form validation
  form.addEventListener('input', validateForm);
  form.addEventListener('change', validateForm);
  
  // Initial validation
  validateForm();
  
  // Form submission
  form.addEventListener('submit', function(e) {
    if (!validateForm()) {
      e.preventDefault();
      return;
    }
    
    const spinner = document.getElementById('profile-spinner');
    spinner.classList.remove('hidden');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <span class="loading loading-spinner loading-sm"></span>
      Completing Profile...
    `;
  });
  
  // Phone number formatting
  const phoneInput = document.getElementById('phone_number');
  phoneInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 0) {
      if (value.length <= 3) {
        value = `(${value}`;
      } else if (value.length <= 6) {
        value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
      } else {
        value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
      }
    }
    e.target.value = value;
  });
  
  // Auto-focus first name field
  document.getElementById('first_name').focus();
});

// Character counter for bio
document.getElementById('bio').addEventListener('input', function() {
  const maxLength = 500;
  const currentLength = this.value.length;
  const remaining = maxLength - currentLength;
  
  // Find or create counter element
  let counter = this.parentNode.querySelector('.char-counter');
  if (!counter) {
    counter = document.createElement('span');
    counter.className = 'char-counter label-text-alt text-right';
    this.parentNode.appendChild(counter);
  }
  
  counter.textContent = `${currentLength}/${maxLength} characters`;
  counter.className = `char-counter label-text-alt text-right ${remaining < 50 ? 'text-warning' : remaining < 10 ? 'text-error' : 'text-base-content/60'}`;
  
  if (currentLength > maxLength) {
    this.value = this.value.substring(0, maxLength);
  }
});
</script>

{% endblock %}
