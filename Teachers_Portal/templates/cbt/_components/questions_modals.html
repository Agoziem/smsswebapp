<!-- CBT Questions Modals Component -->

<!-- Add Question Modal -->
<dialog id="addquestionmodal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg text-primary flex items-center gap-2">
        <i class="fas fa-plus-circle"></i>
        Add New Question
      </h3>
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost">âœ•</button>
      </form>
    </div>

    <form id="addtestquestionform" class="space-y-4">
      <!-- Question Text -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">Question Text</span>
          <span class="label-text-alt text-error">*</span>
        </label>
        <textarea 
          id="questiontextinput" 
          class="textarea textarea-bordered h-32 focus:outline-orange focus:border-orange" 
          placeholder="Enter your question text here..."
          required></textarea>
        <label class="label">
          <span class="label-text-alt text-base-content/60">
            <i class="fas fa-info-circle mr-1"></i>Be clear and specific with your question
          </span>
        </label>
      </div>

      <!-- Answer Options -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">Answer Options</span>
          <span class="label-text-alt text-error">*</span>
        </label>
        
        <div class="answersinput space-y-3" id="answers-container">
          <!-- Initial answer inputs -->
          <div class="answergroup flex items-center gap-3">
            <div class="badge badge-primary">A</div>
            <input type="text" 
                   class="input input-bordered flex-1 focus:outline-orange focus:border-orange" 
                   placeholder="Enter answer option A" 
                   required>
            <button type="button" class="btn btn-sm btn-ghost text-error hidden" onclick="removeAnswer(this)">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="answergroup flex items-center gap-3">
            <div class="badge badge-primary">B</div>
            <input type="text" 
                   class="input input-bordered flex-1 focus:outline-orange focus:border-orange" 
                   placeholder="Enter answer option B" 
                   required>
            <button type="button" class="btn btn-sm btn-ghost text-error hidden" onclick="removeAnswer(this)">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between mt-3">
          <button type="button" 
                  id="addanswersinput" 
                  class="btn btn-sm btn-outline btn-success"
                  onclick="addAnswerInput()">
            <i class="fas fa-plus mr-2"></i>
            Add Answer Option
          </button>
          <div class="text-xs text-base-content/60">
            Maximum 6 options allowed
          </div>
        </div>
      </div>

      <!-- Question Settings -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Question Marks -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Question Marks</span>
          </label>
          <div class="flex items-center gap-2">
            <input type="number" 
                   id="questionmark" 
                   class="input input-bordered w-20 focus:outline-orange focus:border-orange" 
                   value="2" 
                   min="1" 
                   max="10">
            <span class="text-sm text-base-content/70">marks</span>
          </div>
        </div>

        <!-- Question Type -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Question Type</span>
          </label>
          <select class="select select-bordered focus:outline-orange focus:border-orange">
            <option value="multiple-choice">Multiple Choice</option>
            <option value="single-choice">Single Choice</option>
            <option value="true-false">True/False</option>
          </select>
        </div>
      </div>

      <!-- Question Preview -->
      <div class="collapse collapse-arrow bg-base-200">
        <input type="checkbox" />
        <div class="collapse-title text-sm font-medium">
          <i class="fas fa-eye mr-2"></i>
          Preview Question
        </div>
        <div class="collapse-content">
          <div id="question-preview" class="bg-base-100 rounded-lg p-4">
            <div class="text-sm text-base-content/60">Question preview will appear here...</div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-end gap-3 pt-4">
        <form method="dialog">
          <button type="button" class="btn btn-ghost">Cancel</button>
        </form>
        <button type="submit" id="addtestquestionsbtn" class="btn btn-primary">
          <i class="fas fa-plus mr-2"></i>
          Add Question
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Submit Questions Confirmation Modal -->
<dialog id="submitquestionsmodal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-primary mb-4">Confirm Test Creation</h3>
    <div class="py-4">
      <p class="mb-4">Are you sure you want to submit all questions and create this test?</p>
      <div class="bg-info/10 rounded-lg p-4 mb-4">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-info-circle text-info"></i>
          <span class="font-medium text-info">Test Summary</span>
        </div>
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>Questions: <span id="modal-question-count" class="font-bold">0</span></div>
          <div>Total Marks: <span id="modal-total-marks" class="font-bold">0</span></div>
          <div>Duration: <span id="modal-duration" class="font-bold">60 min</span></div>
          <div>Classes: <span id="modal-classes" class="font-bold">3</span></div>
        </div>
      </div>
      <p class="text-sm text-base-content/70">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        Once created, you can edit questions but test structure cannot be changed.
      </p>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost">Cancel</button>
      </form>
      <button id="mainsubmitQuestionbtn" class="btn btn-primary">
        <i class="fas fa-check mr-2"></i>
        Create Test
      </button>
    </div>
  </div>
</dialog>

<!-- Delete All Questions Modal -->
<dialog id="deletequestionsmodal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error mb-4">Delete All Questions</h3>
    <div class="py-4">
      <p class="mb-4">Are you sure you want to delete all questions? This action cannot be undone.</p>
      <div class="alert alert-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        <span>All questions and answers will be permanently removed.</span>
      </div>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost">Cancel</button>
      </form>
      <button id="deleteallquestionbtn" class="btn btn-error">
        <i class="fas fa-trash mr-2"></i>
        Delete All Questions
      </button>
    </div>
  </div>
</dialog>

<!-- Delete Single Question Modal -->
<dialog id="deletequestionModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error mb-4">Delete Question</h3>
    <div class="py-4">
      <p class="mb-4">Are you sure you want to delete this question?</p>
      <div class="bg-error/10 rounded-lg p-4">
        <div class="text-sm text-error">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          This action cannot be undone.
        </div>
      </div>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost">Cancel</button>
      </form>
      <button id="deletequestionbtn" class="btn btn-error" onclick="confirmDeleteQuestion()">
        <i class="fas fa-trash mr-2"></i>
        Delete Question
      </button>
    </div>
  </div>
</dialog>

<script>
let answerCounter = 2; // Start with A and B
const maxAnswers = 6;

// Add new answer input
function addAnswerInput() {
  if (answerCounter >= maxAnswers) {
    alert('Maximum 6 answer options allowed');
    return;
  }

  const container = document.getElementById('answers-container');
  const answerGroup = document.createElement('div');
  answerGroup.className = 'answergroup flex items-center gap-3';
  
  const letter = String.fromCharCode(65 + answerCounter); // A, B, C, D, E, F
  
  answerGroup.innerHTML = `
    <div class="badge badge-primary">${letter}</div>
    <input type="text" 
           class="input input-bordered flex-1 focus:outline-orange focus:border-orange" 
           placeholder="Enter answer option ${letter}" 
           required>
    <button type="button" class="btn btn-sm btn-ghost text-error" onclick="removeAnswer(this)">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  container.appendChild(answerGroup);
  answerCounter++;
  
  // Show remove buttons if more than 2 answers
  if (answerCounter > 2) {
    document.querySelectorAll('.answergroup button').forEach(btn => {
      btn.classList.remove('hidden');
    });
  }
  
  // Hide add button if max reached
  if (answerCounter >= maxAnswers) {
    document.getElementById('addanswersinput').style.display = 'none';
  }
}

// Remove answer input
function removeAnswer(button) {
  if (answerCounter <= 2) {
    alert('Minimum 2 answer options required');
    return;
  }
  
  button.closest('.answergroup').remove();
  answerCounter--;
  
  // Re-label remaining answers
  const answerGroups = document.querySelectorAll('.answergroup');
  answerGroups.forEach((group, index) => {
    const letter = String.fromCharCode(65 + index);
    group.querySelector('.badge').textContent = letter;
    group.querySelector('input').placeholder = `Enter answer option ${letter}`;
  });
  
  // Hide remove buttons if only 2 answers left
  if (answerCounter <= 2) {
    document.querySelectorAll('.answergroup button').forEach(btn => {
      btn.classList.add('hidden');
    });
  }
  
  // Show add button
  document.getElementById('addanswersinput').style.display = 'inline-flex';
}

// Question preview functionality
function updateQuestionPreview() {
  const questionText = document.getElementById('questiontextinput').value;
  const answers = Array.from(document.querySelectorAll('.answergroup input')).map(input => input.value);
  const marks = document.getElementById('questionmark').value;
  
  const preview = document.getElementById('question-preview');
  
  if (!questionText && answers.every(answer => !answer)) {
    preview.innerHTML = '<div class="text-sm text-base-content/60">Question preview will appear here...</div>';
    return;
  }
  
  let previewHTML = `
    <div class="mb-4">
      <div class="flex items-center gap-2 mb-2">
        <div class="badge badge-primary">Q1</div>
        <div class="badge badge-secondary">${marks} marks</div>
      </div>
      <div class="question-text">${questionText || 'Enter question text...'}</div>
    </div>
    <div class="space-y-2">
  `;
  
  answers.forEach((answer, index) => {
    if (answer) {
      const letter = String.fromCharCode(65 + index);
      previewHTML += `
        <label class="label cursor-pointer justify-start gap-3 p-2 bg-base-200 rounded">
          <input type="radio" name="preview" class="radio radio-primary radio-sm" disabled>
          <span class="label-text">${letter}. ${answer}</span>
        </label>
      `;
    }
  });
  
  previewHTML += '</div>';
  preview.innerHTML = previewHTML;
}

// Add event listeners for real-time preview
document.addEventListener('DOMContentLoaded', function() {
  const questionInput = document.getElementById('questiontextinput');
  const marksInput = document.getElementById('questionmark');
  
  if (questionInput) {
    questionInput.addEventListener('input', updateQuestionPreview);
  }
  
  if (marksInput) {
    marksInput.addEventListener('input', updateQuestionPreview);
  }
  
  // Listen for answer input changes
  document.addEventListener('input', function(e) {
    if (e.target.matches('.answergroup input')) {
      updateQuestionPreview();
    }
  });
  
  // Handle form submission
  const addQuestionForm = document.getElementById('addtestquestionform');
  if (addQuestionForm) {
    addQuestionForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const questionText = document.getElementById('questiontextinput').value.trim();
      const answers = Array.from(document.querySelectorAll('.answergroup input'))
        .map(input => input.value.trim())
        .filter(answer => answer.length > 0);
      const marks = parseInt(document.getElementById('questionmark').value);
      
      if (!questionText) {
        alert('Please enter question text');
        return;
      }
      
      if (answers.length < 2) {
        alert('Please provide at least 2 answer options');
        return;
      }
      
      // Create question object
      const questionData = {
        id: Date.now(), // Simple ID generation
        text: questionText,
        marks: marks,
        answers: answers.map((answer, index) => ({
          id: index,
          text: answer
        }))
      };
      
      // Add question to the list
      addQuestionToList(questionData);
      
      // Reset form
      addQuestionForm.reset();
      document.getElementById('questionmark').value = 2;
      updateQuestionPreview();
      
      // Reset answer inputs to default (A and B)
      const container = document.getElementById('answers-container');
      container.innerHTML = `
        <div class="answergroup flex items-center gap-3">
          <div class="badge badge-primary">A</div>
          <input type="text" 
                 class="input input-bordered flex-1 focus:outline-orange focus:border-orange" 
                 placeholder="Enter answer option A" 
                 required>
          <button type="button" class="btn btn-sm btn-ghost text-error hidden" onclick="removeAnswer(this)">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="answergroup flex items-center gap-3">
          <div class="badge badge-primary">B</div>
          <input type="text" 
                 class="input input-bordered flex-1 focus:outline-orange focus:border-orange" 
                 placeholder="Enter answer option B" 
                 required>
          <button type="button" class="btn btn-sm btn-ghost text-error hidden" onclick="removeAnswer(this)">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      answerCounter = 2;
      document.getElementById('addanswersinput').style.display = 'inline-flex';
      
      // Close modal
      document.getElementById('addquestionmodal').close();
    });
  }
  
  // Handle submit questions confirmation
  document.getElementById('mainsubmitQuestionbtn')?.addEventListener('click', function() {
    // Update modal summary
    document.getElementById('modal-question-count').textContent = document.getElementById('question-count').textContent;
    document.getElementById('modal-total-marks').textContent = document.getElementById('total-marks').textContent;
    document.getElementById('modal-duration').textContent = document.getElementById('time').value + ' min';
    
    // Simulate form submission
    alert('Test created successfully! Redirecting to test management...');
    document.getElementById('submitquestionsmodal').close();
  });
  
  // Handle delete all questions
  document.getElementById('deleteallquestionbtn')?.addEventListener('click', function() {
    document.getElementById('QuestionContainer').innerHTML = '';
    questionCounter = 0;
    totalMarks = 0;
    updateQuestionStats();
    
    document.getElementById('no-questions-state').classList.remove('hidden');
    document.getElementById('filter-section').classList.add('hidden');
    document.getElementById('submitQuestionbtn').classList.add('hidden');
    
    document.getElementById('deletequestionsmodal').close();
  });
});
</script>
