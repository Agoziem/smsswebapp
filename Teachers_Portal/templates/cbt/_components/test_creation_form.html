<!-- CBT Test Creation Form Component -->
<div class="flex justify-center">
  <div class="w-full max-w-2xl">
    <div class="bg-base-100 rounded-xl shadow-lg p-6">
      <div class="mb-6">
        <h3 class="text-lg font-bold text-primary flex items-center gap-2">
          <i class="fas fa-plus-circle"></i>
          Create New Test
        </h3>
        <p class="text-sm text-base-content/70 mt-2">Set up a new computer-based test for your students</p>
      </div>

      {% if teacher.FirstName != "None" and teacher.FirstName %}
      <form id="details-form" 
            action="{% url 'Teachers_portal:CBT_Questions' teacher.id %}" 
            method="POST"
            class="space-y-6"
            hx-post="/api/create-cbt-test"
            hx-target="#alert-container"
            hx-swap="innerHTML">
        {% csrf_token %}

        <!-- Test Subject -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Test Subject</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          <select id="testsubject" 
                  class="select select-bordered focus:outline-orange focus:border-orange" 
                  name="subject" 
                  required
                  hx-post="/api/get-subject-info"
                  hx-target="#subject-info"
                  hx-trigger="change">
            <option value="" disabled selected hidden>Select the Test Subject</option>
            {% for subject in teacher.subjects_taught.all %}
              <option value="{{ subject.id }}" data-classes="{{ subject.class_count|default:'0' }}">
                {{ subject.subject_name }}
              </option>
            {% empty %}
              <!-- Dummy subjects for demonstration -->
              <option value="1" data-classes="4">Mathematics</option>
              <option value="2" data-classes="5">English Language</option>
              <option value="3" data-classes="3">Physics</option>
              <option value="4" data-classes="3">Chemistry</option>
              <option value="5" data-classes="2">Biology</option>
              <option value="6" data-classes="6">History</option>
              <option value="7" data-classes="4">Geography</option>
              <option value="8" data-classes="2">Economics</option>
            {% endfor %}
          </select>
          <label class="label">
            <span class="label-text-alt text-base-content/60" id="subject-info">
              <i class="fas fa-info-circle mr-1"></i>Choose the subject for this test
            </span>
          </label>
        </div>

        <!-- Test Classes -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Test Classes</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          <p class="text-xs text-base-content/60 mb-2">You can select multiple classes (Hold Ctrl/Cmd to select multiple)</p>
          <select name="test_classes" 
                  class="select select-bordered h-32 focus:outline-orange focus:border-orange" 
                  multiple 
                  required
                  id="validationCustom06"
                  hx-post="/api/update-class-selection"
                  hx-target="#class-summary"
                  hx-trigger="change">
            {% for class in teacher.classes_taught.all %}
              <option value="{{ class.id }}" class="p-2">
                {{ class.Class }}
              </option>
            {% empty %}
              <!-- Dummy classes for demonstration -->
              <option value="1" class="p-2">SS1A - Senior Secondary 1A (35 students)</option>
              <option value="2" class="p-2">SS1B - Senior Secondary 1B (38 students)</option>
              <option value="3" class="p-2">SS2A - Senior Secondary 2A (42 students)</option>
              <option value="4" class="p-2">SS2B - Senior Secondary 2B (40 students)</option>
              <option value="5" class="p-2">SS3A - Senior Secondary 3A (36 students)</option>
              <option value="6" class="p-2">JSS1A - Junior Secondary 1A (45 students)</option>
              <option value="7" class="p-2">JSS2A - Junior Secondary 2A (43 students)</option>
              <option value="8" class="p-2">JSS3A - Junior Secondary 3A (41 students)</option>
            {% endfor %}
          </select>
          <label class="label">
            <span class="label-text-alt text-error hidden" id="classes-error">
              <i class="fas fa-exclamation-circle mr-1"></i>Please select at least one class
            </span>
          </label>
        </div>

        <!-- Class Selection Summary -->
        <div class="bg-base-200 rounded-lg p-4" id="class-summary">
          <h4 class="font-semibold text-primary mb-3 flex items-center gap-2">
            <i class="fas fa-users"></i>
            Class Selection Summary
          </h4>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
            <div class="bg-base-100 rounded p-3">
              <div class="text-base-content/70">Selected Classes</div>
              <div class="font-bold text-lg text-primary" id="selected-classes">0</div>
            </div>
            <div class="bg-base-100 rounded p-3">
              <div class="text-base-content/70">Total Students</div>
              <div class="font-bold text-lg text-secondary" id="total-students">0</div>
            </div>
            <div class="bg-base-100 rounded p-3">
              <div class="text-base-content/70">Avg Class Size</div>
              <div class="font-bold text-lg text-accent" id="avg-class-size">0</div>
            </div>
            <div class="bg-base-100 rounded p-3">
              <div class="text-base-content/70">Test Duration</div>
              <div class="font-bold text-lg text-info" id="display-duration">20 min</div>
            </div>
          </div>
          <div class="mt-3 text-xs text-base-content/60">
            <i class="fas fa-lightbulb mr-1"></i>
            Select classes that will take this test together
          </div>
        </div>

        <!-- Test Duration -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Test Duration</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          <div class="flex items-center gap-3">
            <input name="testTime" 
                   type="number" 
                   class="input input-bordered focus:outline-orange focus:border-orange flex-1" 
                   value="20" 
                   min="10" 
                   max="180"
                   step="5"
                   required
                   id="testTimeInput"
                   hx-post="/api/validate-test-duration"
                   hx-target="#duration-info"
                   hx-trigger="input changed delay:500ms" />
            <div class="flex items-center gap-2 text-success">
              <i class="fas fa-stopwatch text-2xl"></i>
              <span class="text-sm font-medium">minutes</span>
            </div>
          </div>
          <label class="label">
            <span class="label-text-alt text-base-content/60" id="duration-info">
              <i class="fas fa-info-circle mr-1"></i>Recommended: 2-3 minutes per question
            </span>
          </label>
        </div>

        <!-- Duration Quick Settings -->
        <div class="bg-info/10 border border-info/20 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-clock text-info"></i>
            <span class="font-medium text-info">Quick Duration Settings</span>
          </div>
          <div class="grid grid-cols-4 lg:grid-cols-6 gap-2">
            <button type="button" class="btn btn-sm btn-outline btn-info" onclick="setDuration(15)">15m</button>
            <button type="button" class="btn btn-sm btn-outline btn-info" onclick="setDuration(20)">20m</button>
            <button type="button" class="btn btn-sm btn-outline btn-info" onclick="setDuration(30)">30m</button>
            <button type="button" class="btn btn-sm btn-outline btn-info" onclick="setDuration(45)">45m</button>
            <button type="button" class="btn btn-sm btn-outline btn-info" onclick="setDuration(60)">60m</button>
            <button type="button" class="btn btn-sm btn-outline btn-info" onclick="setDuration(90)">90m</button>
          </div>
        </div>

        <!-- Test Guidelines -->
        <div class="collapse collapse-arrow bg-base-200">
          <input type="checkbox" />
          <div class="collapse-title text-sm font-medium">
            <i class="fas fa-book-open mr-2"></i>
            Test Creation Guidelines
          </div>
          <div class="collapse-content">
            <div class="space-y-3 text-sm">
              <div class="alert alert-info">
                <i class="fas fa-lightbulb"></i>
                <div>
                  <strong>Best Practices:</strong>
                  <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>Plan 2-3 minutes per multiple choice question</li>
                    <li>Add buffer time for technical issues</li>
                    <li>Choose classes with similar academic levels</li>
                    <li>Ensure all selected classes have covered the topics</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex flex-col sm:flex-row justify-end gap-4">
          <button type="button" class="btn btn-ghost order-2 sm:order-1" onclick="history.back()">
            <i class="fas fa-arrow-left mr-2"></i>
            Cancel
          </button>
          <button type="submit" class="btn btn-primary order-1 sm:order-2">
            <span class="loading loading-spinner loading-sm hidden" id="submit-spinner"></span>
            <i class="fas fa-arrow-right mr-2"></i>
            Create Test & Add Questions
          </button>
        </div>
      </form>
      {% else %}
      <!-- Profile Incomplete Message -->
      <div class="text-center py-8">
        <div class="alert alert-warning max-w-md mx-auto">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
          <div>
            <div class="font-medium">Complete Your Profile First</div>
            <div class="text-sm mt-2">
              <a href="{% url 'Teachers_portal:profile' teacher.id %}" class="btn btn-sm btn-primary">
                <i class="fas fa-user-edit mr-2"></i>
                Edit Profile
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Duration setter function
function setDuration(minutes) {
  const input = document.getElementById('testTimeInput');
  const display = document.getElementById('display-duration');
  input.value = minutes;
  display.textContent = minutes + ' min';
}

// Real-time updates
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('details-form');
  const classSelect = document.querySelector('select[name="test_classes"]');
  const timeInput = document.getElementById('testTimeInput');
  
  // Form submission handling
  if (form) {
    form.addEventListener('submit', function(e) {
      const spinner = document.getElementById('submit-spinner');
      const submitBtn = e.target.querySelector('button[type="submit"]');
      
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
    });
  }
  
  // Class selection updates
  if (classSelect) {
    classSelect.addEventListener('change', function() {
      const selectedOptions = Array.from(this.selectedOptions);
      document.getElementById('selected-classes').textContent = selectedOptions.length;
      
      // Calculate total students (dummy calculation)
      let totalStudents = 0;
      selectedOptions.forEach(option => {
        const match = option.textContent.match(/\((\d+) students\)/);
        if (match) {
          totalStudents += parseInt(match[1]);
        }
      });
      
      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('avg-class-size').textContent = 
        selectedOptions.length > 0 ? Math.round(totalStudents / selectedOptions.length) : 0;
    });
  }
  
  // Time input updates
  if (timeInput) {
    timeInput.addEventListener('input', function() {
      document.getElementById('display-duration').textContent = this.value + ' min';
    });
  }
});
</script>
