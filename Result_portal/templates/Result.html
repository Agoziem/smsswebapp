{% load static %} 
{% load django_vite %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{% static 'images/St Marks Logo.png' %}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{% static 'images/St Marks Logo.png' %}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="48x48"
      href="{% static 'images/St Marks Logo.png' %}"
    />

    <!-- icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="{% static 'js/lucide.min.js' %}"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="{% static 'js/htmx.min.js' %}"></script>

    <title>SMSS Omagba - Result Portal</title>
    {% vite_hmr_client %} 
    {% vite_asset 'static/js/index.js' %} 
    {% vite_asset 'static/css/global.css' %}
    <style>
      .display1 {
        font-family: "League Spartan", sans-serif;
        font-weight: 700;
      }
      .display2 {
        font-family: "Josefin Sans", sans-serif;
        font-weight: 600;
      }
      .sideline_text {
        color: #6b7280;
        font-size: 0.875rem;
      }

      @media print {
        .no-print {
          display: none !important;
        }
        .print-only {
          display: block !important;
        }
        body {
          background: white !important;
        }
      }
    </style>

    <script>
      var user = "{{request.user}}";
      function getToken(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          var cookies = document.cookie.split(";");
          for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      var csrftoken = getToken("csrftoken");
    </script>
  </head>

  <body class="bg-base-200">
    <!-- Navigation Bar -->
    {% include 'main_navbar.html' %}

    <!-- Hidden Inputs for Chart Data -->
    <input id="labels" type="hidden" value="{{labels}}" />
    <input id="data" type="hidden" value="{{data}}" />

    <!-- Print Container -->
    <div id="container_result" class="mt-16 lg:mt-20">
      <!-- School Logo -->
      <section class="py-6 bg-base-100">
        <div class="flex justify-center">
          <img
            src="{% static 'images/St Marks Logo.png' %}"
            alt="School Logo"
            class="h-24 w-auto"
          />
        </div>
      </section>

      <!-- School Name and Result Header -->
      <section class="py-6 bg-base-100">
        <div class="text-center">
          <h4 class="text-2xl font-bold text-primary mb-4">
            St Marks Standard Secondary School Omagba (Termly Result)
          </h4>
          <h1 class="text-4xl font-bold display1 text-primary mb-6">
            {{student_details.student_name}}
          </h1>
          <div class="flex justify-center gap-2">
            <div class="h-1 w-16 bg-primary rounded"></div>
            <div class="h-1 w-10 bg-primary/60 rounded"></div>
          </div>
        </div>
      </section>

      <!-- Student Details -->
      <section class="py-6 bg-base-200">
        <div class="container mx-auto px-4">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <div>
                    <span class="font-bold">Class:</span> {{ studentClass.Class
                    }}
                  </div>
                  <div>
                    <span class="font-bold">Term:</span> {{ Result_details.Term
                    }}
                  </div>
                  <div>
                    <span class="font-bold">Session:</span> {{
                    Result_details.AcademicSession }}
                  </div>
                  <div>
                    <span class="font-bold">Total Score:</span> {{
                    Result_details.TotalScore }}
                  </div>
                </div>
                <div class="space-y-2">
                  <div>
                    <span class="font-bold">Average:</span> {{
                    Result_details.Average|floatformat:2 }}
                  </div>
                  <div>
                    <span class="font-bold">Position:</span> {{
                    Result_details.Position }}
                  </div>
                  <div>
                    <span class="font-bold">Number in Class:</span> {{
                    Result_details.Totalnumber }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Results Table -->
      <section class="py-6 bg-base-200">
        <div class="container mx-auto px-4">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-0">
              <div class="overflow-x-auto">
                <table class="table table-zebra">
                  <thead class="bg-primary text-base-100">
                    <tr>
                      <th class="text-center">S/N</th>
                      <th>Subjects</th>
                      <th class="text-center">Test (5)</th>
                      <th class="text-center">Project (5)</th>
                      <th class="text-center">Mid Term Test (20)</th>
                      <th class="text-center">Ass (5)</th>
                      <th class="text-center">Note (5)</th>
                      <th class="text-center">CA (40)</th>
                      <th class="text-center">Exam (60)</th>
                      <th class="text-center">Total (100)</th>
                      <th class="text-center">Grade</th>
                      <th class="text-center">Position</th>
                      <th>Remark</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for data in Results %}
                    <tr class="hover">
                      <td class="text-center font-medium">
                        {{forloop.counter}}
                      </td>
                      <td class="font-medium">{{data.Subject}}</td>
                      <td class="text-center">{{data.FirstTest}}</td>
                      <td class="text-center">{{data.FirstAss}}</td>
                      <td class="text-center">{{data.MidTermTest}}</td>
                      <td class="text-center">{{data.SecondAss}}</td>
                      <td class="text-center">{{data.SecondTest}}</td>
                      <td class="text-center font-semibold">{{data.CA}}</td>
                      <td class="text-center font-semibold">{{data.Exam}}</td>
                      <td class="text-center font-bold text-primary">
                        {{data.Total}}
                      </td>
                      <td class="text-center">
                        <span class="badge badge-primary">{{data.Grade}}</span>
                      </td>
                      <td class="text-center">{{data.SubjectPosition}}</td>
                      <td class="text-sm">{{data.Remark}}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Charts & QR Code -->
      <section class="py-6 bg-base-100">
        <div class="container mx-auto px-4">
          <div class="grid lg:grid-cols-2 gap-8 items-center">
            <div class="flex justify-center">
              <div class="w-full max-w-md">
                <canvas id="mybarChart" class="w-full h-80"></canvas>
              </div>
            </div>
            <div class="flex justify-center">
              <div class="card bg-base-100 shadow-lg">
                <div class="card-body items-center text-center">
                  <h3 class="card-title text-lg mb-4">Verification QR Code</h3>
                  <img
                    src="{% static 'images/Result_QRCode.png' %}"
                    class="w-44 h-auto"
                    alt="QR Code"
                  />
                  <p class="text-sm text-base-content/70 mt-2">
                    Scan to verify result authenticity
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Annual Results Section -->
      {% if Annual_Result %}
      <section class="py-6 bg-base-200">
        <div class="auto-container mx-auto px-4">
          <div class="text-center mb-8">
            <h2 class="text-3xl font-bold display1 text-primary mb-4">
              Annual Result
            </h2>
            <div class="flex justify-center gap-2">
              <div class="h-1 w-16 bg-primary rounded"></div>
              <div class="h-1 w-10 bg-primary/60 rounded"></div>
            </div>
          </div>

          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <div>
                    <span class="font-bold">Session:</span> {{
                    AnnualStudent.academicsession }}
                  </div>
                  <div>
                    <span class="font-bold">Total Score:</span> {{
                    AnnualStudent.TotalScore|floatformat:2 }}
                  </div>
                  <div>
                    <span class="font-bold">Average:</span> {{
                    AnnualStudent.Average|floatformat:2 }}
                  </div>
                </div>
                <div class="space-y-2">
                  <div>
                    <span class="font-bold">Position:</span> {{
                    AnnualStudent.Position }}
                  </div>
                  <div>
                    <span class="font-bold">Number in Class:</span> {{
                    AnnualStudent.Totalnumber }}
                  </div>
                  <div>
                    <span class="font-bold">Principal's Verdict:</span> {{
                    AnnualStudent.Verdict }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-0">
              <div class="overflow-x-auto">
                <table class="table table-zebra">
                  <thead class="bg-primary text-base-100">
                    <tr>
                      <th class="text-center">S/N</th>
                      <th>Subjects</th>
                      <th class="text-center">1st Term</th>
                      <th class="text-center">2nd Term</th>
                      <th class="text-center">3rd Term</th>
                      <th class="text-center">Total</th>
                      <th class="text-center">Average</th>
                      <th class="text-center">Grade</th>
                      <th class="text-center">Position</th>
                      <th>Remark</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for data in AnnualResult %}
                    <tr class="hover">
                      <td class="text-center font-medium">
                        {{forloop.counter}}
                      </td>
                      <td class="font-medium">{{data.Subject}}</td>
                      <td class="text-center">{{data.FirstTermTotal}}</td>
                      <td class="text-center">{{data.SecondTermTotal}}</td>
                      <td class="text-center">{{data.ThirdTermTotal}}</td>
                      <td class="text-center font-bold text-primary">
                        {{data.Total|floatformat}}
                      </td>
                      <td class="text-center font-semibold">
                        {{data.Average|floatformat:2}}
                      </td>
                      <td class="text-center">
                        <span class="badge badge-primary">{{data.Grade}}</span>
                      </td>
                      <td class="text-center">{{data.SubjectPosition}}</td>
                      <td class="text-sm">{{data.Remark}}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endif %}
    </div>
    <!--end of print ////////////////////////////////////////////////////////////// -->

    <!-- Action Buttons Section Following Design System -->
    <section class="py-6 bg-base-100 no-print">
      <div class="auto-container">
        <div class="flex flex-wrap gap-4 justify-center">
          {% if isTermNewsletter %}
          <a
            href="{{ TermNewsletter.NewsletterURL }}"
            class="btn btn-outline btn-secondary gap-2"
            download="{{ TermNewsletter.NewsletterURL }}"
          >
            <i class="fa-solid fa-download"></i>
            {{ TermNewsletter.currentTerm.term }} Newsletter
          </a>
          {% endif %}

          <button id="result_btn" class="btn btn-primary gap-2">
            <i class="fa-solid fa-file-pdf"></i>
            Save as PDF
            <span class="loading loading-spinner loading-sm hidden"></span>
          </button>

          <a href="{% url 'home' %}" class="btn btn-info gap-2">
            <i class="fa-solid fa-house"></i>
            Back to Home
          </a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    {% include 'main_footer.html' %}

    <script>
      // Initialize Lucide icons
      lucide.createIcons();
    </script>
  </body>
</html>
