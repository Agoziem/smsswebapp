{% extends 'base.html' %}
{% load static %}

{% block title %} Reset Password {% endblock %}

{% block content %}
<section class="py-8 bg-base-200 min-h-screen">
  <div class="container mx-auto px-4">
    <!-- Page Header -->
    <div class="text-center mb-8">
      <div class="sideline_text text-primary mb-2">Account Recovery</div>
      <h1 class="text-4xl font-bold text-primary mb-4">Reset Password</h1>
      <p class="text-base-content/70 max-w-md mx-auto">
        Create a new secure password for your account. Make sure it's strong and unique.
      </p>
    </div>

    <div class="flex justify-center">
      <div class="card bg-base-100 shadow-2xl max-w-md w-full">
        <div class="card-body p-8">
          <!-- Alert Messages -->
          {% if messages %}
          {% for message in messages %}
          <div class="alert {{ message.tags|default:'alert-info' }} shadow-lg mb-6" role="alert">
            {% if message.tags == 'error' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% elif message.tags == 'success' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% else %}
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {% endif %}
            <span>{{ message }}</span>
          </div>
          {% endfor %}
          {% endif %}

          <!-- School Logo & Title -->
          <div class="text-center space-y-6 mb-8">
            <div class="avatar">
              <div class="w-20 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                <img src="{% static 'images/St Marks Logo.png' %}" alt="School Logo" />
              </div>
            </div>
            
            <div class="space-y-2">
              <h2 class="text-2xl font-bold text-primary">Create New Password</h2>
              <p class="text-base-content/70 text-sm">
                Choose a strong password to secure your account
              </p>
            </div>
          </div>

          <!-- Password Reset Form -->
          <form
            id="reset-password-form"
            method="POST"
            action=""
            class="space-y-6"
            hx-post=""
            hx-target="#form-container"
            hx-swap="outerHTML"
          >
            <div id="form-container">
              {% csrf_token %}
              
              <!-- New Password -->
              <div class="form-control">
                <label class="label" for="new_password1">
                  <span class="label-text font-semibold">
                    New Password <span class="text-error">*</span>
                  </span>
                </label>
                <div class="relative">
                  <input
                    type="password"
                    name="new_password1"
                    id="new_password1"
                    placeholder="Create a strong new password"
                    class="input input-bordered w-full pl-10 pr-12"
                    required
                    autocomplete="new-password"
                  />
                  <svg class="absolute left-3 top-3 h-5 w-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                  <button type="button" class="absolute right-3 top-3 toggle-password" data-target="new_password1">
                    <svg class="h-5 w-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                </div>
                
                <!-- Password Strength Indicator -->
                <div class="mt-2">
                  <div class="flex space-x-1">
                    <div class="h-1 flex-1 bg-base-300 rounded" id="strength-1"></div>
                    <div class="h-1 flex-1 bg-base-300 rounded" id="strength-2"></div>
                    <div class="h-1 flex-1 bg-base-300 rounded" id="strength-3"></div>
                    <div class="h-1 flex-1 bg-base-300 rounded" id="strength-4"></div>
                  </div>
                  <span class="label-text-alt text-base-content/60" id="strength-text">
                    Password strength will appear here
                  </span>
                </div>
              </div>

              <!-- Confirm Password -->
              <div class="form-control">
                <label class="label" for="new_password2">
                  <span class="label-text font-semibold">
                    Confirm New Password <span class="text-error">*</span>
                  </span>
                </label>
                <div class="relative">
                  <input
                    type="password"
                    name="new_password2"
                    id="new_password2"
                    placeholder="Confirm your new password"
                    class="input input-bordered w-full pl-10 pr-12"
                    required
                    autocomplete="new-password"
                  />
                  <svg class="absolute left-3 top-3 h-5 w-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <button type="button" class="absolute right-3 top-3 toggle-password" data-target="new_password2">
                    <svg class="h-5 w-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                </div>
                <span id="password-match-error" class="label-text-alt text-error hidden">
                  Passwords do not match
                </span>
              </div>

              <!-- Password Requirements -->
              <div class="bg-base-200 rounded-lg p-4">
                <h3 class="font-semibold text-sm mb-3">Password Requirements:</h3>
                <ul class="space-y-2 text-sm">
                  <li class="flex items-center space-x-2" id="req-length">
                    <svg class="h-4 w-4 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>At least 8 characters long</span>
                  </li>
                  <li class="flex items-center space-x-2" id="req-lowercase">
                    <svg class="h-4 w-4 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>Contains lowercase letters</span>
                  </li>
                  <li class="flex items-center space-x-2" id="req-uppercase">
                    <svg class="h-4 w-4 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>Contains uppercase letters</span>
                  </li>
                  <li class="flex items-center space-x-2" id="req-numbers">
                    <svg class="h-4 w-4 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>Contains numbers</span>
                  </li>
                  <li class="flex items-center space-x-2" id="req-special">
                    <svg class="h-4 w-4 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>Contains special characters</span>
                  </li>
                </ul>
              </div>

              <!-- Submit Button -->
              <button
                id="submit-btn"
                type="submit"
                class="btn btn-primary w-full text-lg py-3"
                disabled
              >
                <span class="loading loading-spinner loading-sm hidden" id="reset-spinner"></span>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                Reset Password
              </button>
            </div>
          </form>

          <!-- Additional Options -->
          <div class="divider text-sm">Need help?</div>
          
          <div class="space-y-4">
            <div class="text-center">
              <p class="text-sm text-base-content/70 mb-4">
                Remember your password?
              </p>
              <a href="{% url 'Accounts:login' %}" class="btn btn-outline btn-primary w-full">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
                Back to Sign In
              </a>
            </div>
          </div>

          <!-- Security Notice -->
          <div class="bg-info/10 border-l-4 border-info rounded-lg p-4 mt-6">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-info mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <h3 class="font-semibold text-sm mb-1">Security Notice</h3>
                <p class="text-xs text-base-content/70">
                  After resetting your password, you'll be automatically signed in and redirected to your dashboard.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('reset-password-form');
  const submitBtn = document.getElementById('submit-btn');
  const password1 = document.getElementById('new_password1');
  const password2 = document.getElementById('new_password2');
  
  // Password toggle functionality
  document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      const icon = this.querySelector('svg');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L12 12m-3.122-3.122L3 3m6.878 6.878L12 12" />
        `;
      } else {
        input.type = 'password';
        icon.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        `;
      }
    });
  });
  
  // Password strength and validation
  password1.addEventListener('input', function() {
    const password = this.value;
    const strength = calculatePasswordStrength(password);
    updatePasswordStrength(strength);
    validatePasswordRequirements(password);
    validateForm();
  });
  
  // Password match validation
  function validatePasswordMatch() {
    const errorElement = document.getElementById('password-match-error');
    if (password1.value && password2.value) {
      if (password1.value === password2.value) {
        errorElement.classList.add('hidden');
        password2.classList.remove('input-error');
        return true;
      } else {
        errorElement.classList.remove('hidden');
        password2.classList.add('input-error');
        return false;
      }
    }
    return password1.value === password2.value;
  }
  
  password2.addEventListener('input', validatePasswordMatch);
  password2.addEventListener('blur', validatePasswordMatch);
  
  // Form validation
  function validateForm() {
    const passwordValid = password1.value.length >= 8;
    const passwordsMatch = validatePasswordMatch();
    const isValid = passwordValid && passwordsMatch;
    submitBtn.disabled = !isValid;
  }
  
  // Form submission
  form.addEventListener('submit', function(e) {
    if (!validatePasswordMatch()) {
      e.preventDefault();
      return;
    }
    
    const spinner = document.getElementById('reset-spinner');
    spinner.classList.remove('hidden');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <span class="loading loading-spinner loading-sm"></span>
      Resetting Password...
    `;
  });
  
  // Auto-focus first password field
  password1.focus();
});

function calculatePasswordStrength(password) {
  let strength = 0;
  
  if (password.length >= 8) strength++;
  if (/[a-z]/.test(password)) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^A-Za-z0-9]/.test(password)) strength++;
  
  return Math.min(4, strength);
}

function updatePasswordStrength(strength) {
  const strengthBars = ['strength-1', 'strength-2', 'strength-3', 'strength-4'];
  const strengthText = document.getElementById('strength-text');
  const colors = ['bg-error', 'bg-warning', 'bg-info', 'bg-success'];
  const texts = ['Very Weak', 'Weak', 'Good', 'Strong'];
  
  // Reset all bars
  strengthBars.forEach(id => {
    const bar = document.getElementById(id);
    bar.className = 'h-1 flex-1 bg-base-300 rounded';
  });
  
  // Fill bars based on strength
  for (let i = 0; i < strength; i++) {
    const bar = document.getElementById(strengthBars[i]);
    bar.classList.add(colors[Math.min(strength - 1, 3)]);
  }
  
  if (strength > 0) {
    strengthText.textContent = texts[Math.min(strength - 1, 3)] + ' password';
    strengthText.className = `label-text-alt ${colors[Math.min(strength - 1, 3)].replace('bg-', 'text-')}`;
  } else {
    strengthText.textContent = 'Password strength will appear here';
    strengthText.className = 'label-text-alt text-base-content/60';
  }
}

function validatePasswordRequirements(password) {
  const requirements = [
    { id: 'req-length', test: password.length >= 8 },
    { id: 'req-lowercase', test: /[a-z]/.test(password) },
    { id: 'req-uppercase', test: /[A-Z]/.test(password) },
    { id: 'req-numbers', test: /[0-9]/.test(password) },
    { id: 'req-special', test: /[^A-Za-z0-9]/.test(password) }
  ];
  
  requirements.forEach(req => {
    const element = document.getElementById(req.id);
    const icon = element.querySelector('svg');
    const text = element.querySelector('span');
    
    if (req.test) {
      icon.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      `;
      icon.className = 'h-4 w-4 text-success';
      text.className = 'text-success';
    } else {
      icon.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      `;
      icon.className = 'h-4 w-4 text-base-content/50';
      text.className = '';
    }
  });
}
</script>

{% endblock %}
